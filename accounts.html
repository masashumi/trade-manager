<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’¼ å£åº§ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen">
  <div class="container mx-auto p-4 sm:p-8 max-w-7xl">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">ğŸ’¼ å£åº§ç®¡ç†</h1>
        <p class="text-gray-600 mt-2">è¨¼åˆ¸å£åº§ã®æ®‹é«˜ã¨æç›Šã‚’ç®¡ç†</p>
      </div>
      <div class="flex gap-2">
        <a href="index.html" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 transition shadow-lg">ğŸ¯ ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²</a>
        <a href="stats.html" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition shadow-lg">ğŸ“Š çµ±è¨ˆ</a>
        <a href="technical.html" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 transition shadow-lg">ğŸ“ˆ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«</a>
      </div>
    </div>

    <!-- ç®¡ç†ãƒœã‚¿ãƒ³ -->
    <div class="flex gap-2 mb-8 flex-wrap">
      <button onclick="handleJSONBackup()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition shadow-lg font-bold">ğŸ’¾ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <label class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition shadow-lg font-bold cursor-pointer">
        ğŸ“¥ JSONå¾©å…ƒ
        <input type="file" accept=".json" onchange="handleJSONRestore(event)" class="hidden">
      </label>
      <button onclick="handleResetBaselineDates()" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 transition shadow-lg font-bold">ğŸ”„ åŸºæº–æ—¥ã‚’ä¸€æ‹¬ãƒªã‚»ãƒƒãƒˆ</button>
      <button onclick="handleClearAllAccounts()" class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:from-red-600 hover:to-red-700 transition shadow-lg font-bold">ğŸ—‘ï¸ å…¨å£åº§å‰Šé™¤</button>
    </div>

    <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl shadow-xl text-white">
        <p class="text-sm opacity-90 mb-1">ğŸ’µ ç¾é‡‘</p>
        <p id="cashBalance" class="text-3xl font-bold">Â¥0</p>
      </div>
      <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl shadow-xl text-white">
        <p class="text-sm opacity-90 mb-1">ğŸ’ ç·è³‡ç”£</p>
        <p id="totalAssets" class="text-3xl font-bold">Â¥0</p>
        <p class="text-xs mt-2 opacity-80">ç¾é‡‘ + è¨¼åˆ¸æ®‹é«˜</p>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl shadow-xl text-white">
        <p class="text-sm opacity-90 mb-1">ç·æŠ•è³‡é¡</p>
        <p id="totalDeposits" class="text-3xl font-bold">Â¥0</p>
      </div>
      <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-2xl shadow-xl text-white">
        <p class="text-sm opacity-90 mb-1">ç·æç›Š</p>
        <p id="totalPnL" class="text-3xl font-bold">Â¥0</p>
      </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-900 mb-4">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
      <div id="debugInfo" class="space-y-2 text-sm"></div>
    </div>

    <!-- æ®‹é«˜ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editBalanceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
        <div class="bg-gradient-to-r from-blue-500 to-purple-500 p-6 rounded-t-2xl">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-white">âœï¸ æ®‹é«˜ã‚’ç·¨é›†</h2>
            <button onclick="closeEditBalanceModal()" class="text-white hover:text-gray-200 text-2xl">âœ•</button>
          </div>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <p class="text-lg font-bold text-gray-900 mb-2">è¨¼åˆ¸ä¼šç¤¾: <span id="editBrokerName"></span></p>
          </div>
          
          <div class="space-y-4">
            <div class="bg-blue-50 rounded-lg p-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">ç¾åœ¨æ®‹é«˜ï¼ˆå††ï¼‰</label>
              <input type="number" id="editBalanceAmount" class="w-full px-3 py-2 border-2 border-blue-200 rounded-xl text-lg font-bold">
              <p class="text-xs text-gray-500 mt-2">ğŸ’¡ ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç¢ºèªã—ãŸæœ€æ–°ã®æ®‹é«˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="saveEditBalance()" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-bold">ğŸ’¾ ä¿å­˜</button>
            <button onclick="closeEditBalanceModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è¨¼åˆ¸å£åº§ä¸€è¦§ -->
    <div class="bg-white rounded-2xl shadow-xl border-2 border-blue-200 p-6 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ¦ è¨¼åˆ¸å£åº§ä¸€è¦§</h2>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gradient-to-r from-blue-100 to-purple-100">
            <tr>
              <th class="px-4 py-3 text-left">è¨¼åˆ¸ä¼šç¤¾</th>
              <th class="px-4 py-3 text-right">ç¾åœ¨æ®‹é«˜</th>
              <th class="px-4 py-3 text-right">æç›Š</th>
              <th class="px-4 py-3 text-center">ãƒˆãƒ¬ãƒ¼ãƒ‰ä»¶æ•°</th>
              <th class="px-4 py-3 text-center">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="accountsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ã‚°ãƒ©ãƒ• -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="bg-white rounded-2xl shadow-xl border-2 border-blue-200 p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4">å£åº§åˆ¥æ®‹é«˜</h3>
        <canvas id="balanceChart"></canvas>
      </div>
      <div class="bg-white rounded-2xl shadow-xl border-2 border-blue-200 p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4">ç·è³‡ç”£æ¨ç§»</h3>
        <canvas id="assetsChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    const STORAGE_KEY = 'my-finance:pnl_entries:v3';
    const ACCOUNTS_KEY = 'my-finance:accounts-data:v1';
    
    let investmentData = { entries: [] };
    let accountsData = { version: '3.1', accounts: {}, cash: { initialBalance: 0, initialDate: '', adjustments: [] } };

    // åˆæœŸåŒ–
    function init() {
      loadData();
      renderAccountsTable();
      renderCharts();
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadData() {
      // ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆâ˜…é…åˆ—ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ç›´æ¥èª­ã¿è¾¼ã‚€ï¼‰
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        const parsed = JSON.parse(data);
        // é…åˆ—ã®å ´åˆã¯ãã®ã¾ã¾ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯entriesã‚’å–ã‚Šå‡ºã™
        investmentData.entries = Array.isArray(parsed) ? parsed : (parsed.entries || []);
      }

      // å£åº§ãƒ‡ãƒ¼ã‚¿
      const accounts = localStorage.getItem(ACCOUNTS_KEY);
      if (accounts) {
        accountsData = JSON.parse(accounts);
      }

      console.log('ğŸ“Š ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', investmentData.entries.length, 'ä»¶');
      console.log('ğŸ’¼ å£åº§ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(accountsData.accounts || {}).length, 'ä»¶');
      console.log('ğŸ” è¨¼åˆ¸ä¼šç¤¾ä¸€è¦§:', [...new Set(investmentData.entries.map(e => e.brokerAccount))].join(', '));
    }

    // è¨¼åˆ¸ä¼šç¤¾åˆ¥ã®æç›Šè¨ˆç®—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
    function calculateBrokerPnL(broker, baselineDate = null) {
      const entries = investmentData.entries || [];
      let filteredEntries = entries.filter(e => e.brokerAccount === broker);
      
      if (baselineDate) {
        filteredEntries = filteredEntries.filter(e => e.date > baselineDate);
      }

      const totalPnL = filteredEntries.reduce((sum, e) => sum + (e.pnlJPY || 0), 0);
      const count = filteredEntries.length;

      return { totalPnL, count, entries: filteredEntries };
    }

    // å£åº§ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderAccountsTable() {
      const accounts = accountsData.accounts || {};
      const brokers = Object.keys(accounts);

      if (brokers.length === 0) {
        document.getElementById('accountsTable').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">å£åº§ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        updateSummary(0, 0, 0, 0);
        return;
      }

      let totalBalance = 0;
      let debugInfo = [];

      const rows = brokers.map(broker => {
        const account = accounts[broker];
        const { totalPnL: allPnL, count: allCount } = calculateBrokerPnL(broker, null);

        // â˜…ã‚·ãƒ³ãƒ—ãƒ«è¨­è¨ˆ: æ®‹é«˜ã ã‘
        const currentBalance = account.balance || 0;
        totalBalance += currentBalance;

        debugInfo.push(`<strong>${broker}</strong>: å…¨æœŸé–“${allCount}ä»¶(${fmtJPY(allPnL)})`);

        return `
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-3 font-medium">${broker}</td>
            <td class="px-4 py-3 text-right font-bold">${fmtJPY2(currentBalance)}</td>
            <td class="px-4 py-3 text-right font-bold ${allPnL >= 0 ? 'text-green-600' : 'text-red-600'}">${fmtJPY(allPnL)}</td>
            <td class="px-4 py-3 text-center">${allCount}ä»¶</td>
            <td class="px-4 py-3 text-center">
              <button onclick="editAccount('${broker}')" class="text-blue-600 hover:text-blue-800">âœï¸</button>
              <button onclick="deleteAccount('${broker}')" class="text-red-600 hover:text-red-800 ml-2">ğŸ—‘ï¸</button>
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('accountsTable').innerHTML = rows;

      // â˜…â˜…â˜… ç·æç›Šã¯å…¨ã‚¨ãƒ³ãƒˆãƒªã‹ã‚‰ç›´æ¥è¨ˆç®— â˜…â˜…â˜…
      const allEntries = investmentData.entries || [];
      const actualTotalPnL = allEntries.reduce((sum, e) => sum + (e.pnlJPY || 0), 0);
      
      // ç·æŠ•è³‡é¡ = ç·è³‡ç”£ - ç·æç›Š
      const totalInvestment = totalBalance - actualTotalPnL;
      
      updateSummary(totalBalance, totalInvestment, actualTotalPnL, brokers.length);

      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
      const allBrokers = [...new Set(allEntries.map(e => e.brokerAccount))].filter(b => b);
      
      document.getElementById('debugInfo').innerHTML = `
        <p><strong>ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ç·ä»¶æ•°:</strong> ${allEntries.length}ä»¶</p>
        <p><strong>ç·æç›Šï¼ˆå…¨ãƒˆãƒ¬ãƒ¼ãƒ‰ï¼‰:</strong> ${fmtJPY(actualTotalPnL)}</p>
        <p><strong>ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹è¨¼åˆ¸ä¼šç¤¾:</strong> ${allBrokers.join(', ')}</p>
        <p class="mt-2"><strong>å£åº§ãƒ‡ãƒ¼ã‚¿ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è¨¼åˆ¸ä¼šç¤¾:</strong> ${brokers.join(', ')}</p>
        <p class="mt-2"><strong>è¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼ˆå£åº§ãƒ‡ãƒ¼ã‚¿åŸºæº–ï¼‰:</strong></p>
        ${debugInfo.map(info => `<p class="ml-4">â€¢ ${info}</p>`).join('')}
        <p class="mt-2"><strong>â˜…å®Ÿéš›ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å†…è¨³:</strong></p>
        ${allBrokers.map(broker => {
          const brokerEntries = allEntries.filter(e => e.brokerAccount === broker);
          const brokerPnL = brokerEntries.reduce((sum, e) => sum + (e.pnlJPY || 0), 0);
          return `<p class="ml-4">â€¢ ${broker}: ${brokerEntries.length}ä»¶, ${fmtJPY(brokerPnL)}</p>`;
        }).join('')}
      `;
    }

    // ã‚µãƒãƒªãƒ¼æ›´æ–°
    function updateSummary(accountsBalance, totalInvestment, pnl, count) {
      // ç¾é‡‘æ®‹é«˜ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼šcashãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä½¿ã†ï¼‰
      const cashBalance = accountsData.cash?.initialBalance || 0;
      
      // ç·è³‡ç”£ = ç¾é‡‘ + è¨¼åˆ¸å£åº§ã®æ®‹é«˜åˆè¨ˆ
      const totalAssets = cashBalance + accountsBalance;
      
      document.getElementById('cashBalance').textContent = fmtJPY2(cashBalance);
      document.getElementById('totalAssets').textContent = fmtJPY2(totalAssets);
      document.getElementById('totalDeposits').textContent = fmtJPY2(totalInvestment);
      document.getElementById('totalPnL').textContent = fmtJPY(pnl);
    }

    // ã‚°ãƒ©ãƒ•ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderCharts() {
      const accounts = accountsData.accounts || {};
      const brokers = Object.keys(accounts);

      if (brokers.length === 0) return;

      // å£åº§åˆ¥æ®‹é«˜ã‚°ãƒ©ãƒ•
      const balances = brokers.map(broker => {
        const account = accounts[broker];
        const { totalPnL: pnl } = calculateBrokerPnL(broker, account.inputMode === 'balance' ? account.baselineDate : null);
        
        if (account.inputMode === 'balance') {
          return account.baselineBalance + pnl;
        } else {
          const { totalPnL: allPnL } = calculateBrokerPnL(broker, null);
          return (account.baselineInvestment || 0) + allPnL;
        }
      });

      const balanceCtx = document.getElementById('balanceChart').getContext('2d');
      new Chart(balanceCtx, {
        type: 'doughnut',
        data: {
          labels: brokers,
          datasets: [{
            data: balances,
            backgroundColor: [
              'rgba(59, 130, 246, 0.8)',
              'rgba(168, 85, 247, 0.8)',
              'rgba(236, 72, 153, 0.8)',
              'rgba(34, 197, 94, 0.8)',
              'rgba(251, 146, 60, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // ç·è³‡ç”£æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆéå»6ãƒ¶æœˆï¼‰
      const months = [];
      const assetsHistory = [];
      const today = new Date();
      
      for (let i = 5; i >= 0; i--) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        months.push(monthStr);

        // ãã®æœˆæœ«ã¾ã§ã®ç´¯ç©è³‡ç”£ã‚’è¨ˆç®—
        let totalAsset = 0;
        brokers.forEach(broker => {
          const account = accounts[broker];
          const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
          const { totalPnL: pnl } = calculateBrokerPnL(broker, account.inputMode === 'balance' ? account.baselineDate : null);
          
          // baselineDate ã‚ˆã‚Šå‰ãªã‚‰è³‡ç”£ã¯0
          if (account.baselineDate && endOfMonth < new Date(account.baselineDate)) {
            return;
          }

          if (account.inputMode === 'balance') {
            totalAsset += account.baselineBalance + pnl;
          } else {
            const { totalPnL: allPnL } = calculateBrokerPnL(broker, null);
            totalAsset += (account.baselineInvestment || 0) + allPnL;
          }
        });
        assetsHistory.push(totalAsset);
      }

      const assetsCtx = document.getElementById('assetsChart').getContext('2d');
      new Chart(assetsCtx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'ç·è³‡ç”£',
            data: assetsHistory,
            borderColor: 'rgba(59, 130, 246, 1)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'Â¥' + value.toLocaleString('ja-JP');
                }
              }
            }
          }
        }
      });
    }

    // JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    function handleJSONBackup() {
      // ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æƒ…å ±ã‚’å–å¾—
      let latestTradeDate = null;
      let totalTradeCount = 0;
      let totalTradePnL = 0;
      
      const tradeData = localStorage.getItem(STORAGE_KEY);
      if (tradeData) {
        try {
          const entries = JSON.parse(tradeData);
          const dates = entries.map(e => e.date).sort();
          latestTradeDate = dates[dates.length - 1];
          totalTradeCount = entries.length;
          totalTradePnL = entries.reduce((sum, e) => sum + (e.pnlJPY || 0), 0);
        } catch (err) {
          console.error('ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
        }
      }
      
      const backupData = {
        version: '4.0',
        exportDate: new Date().toISOString(),
        latestTradeDate: latestTradeDate,
        totalTradeCount: totalTradeCount,
        totalTradePnL: totalTradePnL,
        accounts: accountsData.accounts,
        cash: accountsData.cash
      };
      
      const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `accounts-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      alert(`âœ… JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ï¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ v4.0ï¼‰\n\nãƒˆãƒ¬ãƒ¼ãƒ‰æœ€æ–°æ—¥: ${latestTradeDate}\nç·å–å¼•ä»¶æ•°: ${totalTradeCount}ä»¶\nç·æç›Š: ${fmtJPY(totalTradePnL)}`);
    }

    // JSONå¾©å…ƒ
    function handleJSONRestore(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!data.version || !data.accounts) {
            alert('âš ï¸ ä¸æ­£ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
            return;
          }
          
          // â˜…â˜…â˜… é…åˆ—å½¢å¼ã‚’è‡ªå‹•å¤‰æ› â˜…â˜…â˜…
          if (Array.isArray(data.accounts)) {
            console.log('ğŸ“ é…åˆ—å½¢å¼ã‚’æ¤œå‡ºã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã«å¤‰æ›ã—ã¾ã™...');
            const accountsObj = {};
            data.accounts.forEach(acc => {
              accountsObj[acc.broker] = acc;
            });
            data.accounts = accountsObj;
            console.log('âœ… å¤‰æ›å®Œäº†:', Object.keys(accountsObj));
          }
          
          // â˜…â˜…â˜… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±ã‚’è¡¨ç¤º â˜…â˜…â˜…
          let backupInfo = `ğŸ“¦ å£åº§ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã€‚\n\n`;
          backupInfo += `ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${data.version}\n`;
          backupInfo += `ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥: ${new Date(data.exportDate).toLocaleString('ja-JP')}\n`;
          backupInfo += `å£åº§æ•°: ${Object.keys(data.accounts || {}).length}ä»¶\n`;
          
          if (data.latestTradeDate) {
            backupInfo += `\nğŸ“Š ãƒˆãƒ¬ãƒ¼ãƒ‰æƒ…å ±:\n`;
            backupInfo += `æœ€æ–°å–å¼•æ—¥: ${data.latestTradeDate}\n`;
            backupInfo += `ç·å–å¼•ä»¶æ•°: ${data.totalTradeCount}ä»¶\n`;
            backupInfo += `ç·æç›Š: ${fmtJPY(data.totalTradePnL)}\n`;
          }
          
          backupInfo += `\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
          
          if (!confirm(backupInfo)) return;
          
          // â˜…â˜…â˜… åŸºæº–æ—¥ã‚’è‡ªå‹•èª¿æ•´ â˜…â˜…â˜…
          const tradeData = localStorage.getItem(STORAGE_KEY);
          if (tradeData) {
            try {
              const entries = JSON.parse(tradeData);
              const dates = entries.map(e => e.date).sort();
              const latestTradeDate = dates[dates.length - 1];
              
              console.log('ğŸ“… ç¾åœ¨ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æœ€æ–°æ—¥:', latestTradeDate);
              console.log('ğŸ“… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æœ€æ–°æ—¥:', data.latestTradeDate);
              
              let adjustedCount = 0;
              Object.keys(data.accounts).forEach(broker => {
                const account = data.accounts[broker];
                
                // â˜…â˜…â˜… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥ã‚’è¨˜éŒ² â˜…â˜…â˜…
                account.backupDate = data.latestTradeDate || account.baselineDate;
                
                // åŸºæº–æ—¥ãŒæœªæ¥ã™ãã‚‹å ´åˆã¯è‡ªå‹•èª¿æ•´
                if (account.baselineDate > latestTradeDate) {
                  console.warn(`âš ï¸ ${broker}ã®åŸºæº–æ—¥ãŒæœªæ¥ã™ãã‚‹: ${account.baselineDate} â†’ 2024-01-01ã«è‡ªå‹•èª¿æ•´`);
                  account.baselineDate = '2024-01-01';
                  adjustedCount++;
                }
                
                // â˜…â˜…â˜… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«æç›ŠãŒä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã¯è¨ˆç®— â˜…â˜…â˜…
                if (account.baselinePnL === undefined || account.afterBaselinePnL === undefined) {
                  const baselinePnL = entries
                    .filter(e => e.brokerAccount === broker && e.date <= account.baselineDate)
                    .reduce((sum, e) => sum + (e.pnlJPY || 0), 0);
                  
                  const afterBaselinePnL = entries
                    .filter(e => e.brokerAccount === broker && e.date > account.baselineDate)
                    .reduce((sum, e) => sum + (e.pnlJPY || 0), 0);
                  
                  account.baselinePnL = baselinePnL;
                  account.afterBaselinePnL = afterBaselinePnL;
                  
                  console.log(`ğŸ”„ ${broker}: æç›Šã‚’å†è¨ˆç®— baseline=${baselinePnL}, after=${afterBaselinePnL}`);
                }
              });
              
              if (adjustedCount > 0) {
                alert(`âš ï¸ ${adjustedCount}ä»¶ã®å£åº§ã®åŸºæº–æ—¥ãŒæœªæ¥ã ã£ãŸãŸã‚ã€2024-01-01ã«è‡ªå‹•èª¿æ•´ã—ã¾ã—ãŸ`);
              }
            } catch (err) {
              console.error('åŸºæº–æ—¥èª¿æ•´ã‚¨ãƒ©ãƒ¼:', err);
            }
          }
          
          accountsData = {
            version: data.version,
            accounts: data.accounts,
            cash: data.cash || { id: 'cash', initialBalance: 0, initialDate: '', adjustments: [] }
          };
          localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accountsData));
          init();
          alert(`âœ… å¾©å…ƒå®Œäº†ï¼\nå£åº§æ•°: ${Object.keys(data.accounts || {}).length}ä»¶`);
          event.target.value = '';
        } catch (err) {
          alert(`âŒ å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ${err}`);
        }
      };
      reader.readAsText(file);
    }

    // å£åº§ç·¨é›†
    let editingBroker = null;
    
    function editAccount(broker) {
      editingBroker = broker;
      const account = accountsData.accounts[broker];
      if (!account) return;
      
      document.getElementById('editBrokerName').textContent = broker;
      document.getElementById('editBalanceAmount').value = account.balance || 0;
      
      document.getElementById('editBalanceModal').classList.remove('hidden');
    }
    
    function closeEditBalanceModal() {
      document.getElementById('editBalanceModal').classList.add('hidden');
      editingBroker = null;
    }
    
    function saveEditBalance() {
      if (!editingBroker) return;
      
      const balance = parseFloat(document.getElementById('editBalanceAmount').value);
      if (isNaN(balance) || balance < 0) {
        alert('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      accountsData.accounts[editingBroker] = {
        broker: editingBroker,
        balance: balance,
        updatedAt: new Date().toISOString()
      };
      
      localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accountsData));
      
      closeEditBalanceModal();
      init();
      alert('âœ… æ®‹é«˜ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
    }

    // å£åº§å‰Šé™¤
    function deleteAccount(broker) {
      if (!confirm(`âš ï¸ ${broker}ã®å£åº§ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      delete accountsData.accounts[broker];
      localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accountsData));
      init();
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function fmtJPY(n) {
      return `${n >= 0 ? '+' : ''}${n.toLocaleString('ja-JP')}å††`;
    }

    function fmtJPY2(n) {
      return `Â¥${n.toLocaleString('ja-JP')}`;
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>