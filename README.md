# 🎯 投資管理システム統合版 v6.1

トレード記録と口座管理を統合した、超シンプルな投資管理システムです。

## 🎉 v6.1 の新機能（Table API統合）

### 💾 クラウドバックアップ対応
- **Table API統合**: バックアップをクラウドに自動保存
- **2つの復元方法**:
  - 📥 **復元（Table API）**: サーバーに保存されたバックアップから選択して復元
  - 📥 **復元（ファイル）**: ローカルJSONファイルから復元
- **自動ダウンロード**: バックアップ時にローカルファイルも同時に保存
- **バックアップ履歴**: 最大50件のバックアップを保存・管理

### ✨ 超シンプル設計
- **各口座は「残高」と「基準日」だけ**
- **投資額は自動計算**
- **残高調整だけで管理が完結**

### 🕐 タイムスタンプベースの完全自動管理（v6.0新機能）
#### 入力時刻・修正時刻を自動記録
- **取引入力時**: inputTimestamp（入力時刻）を自動記録
- **残高修正時**: baselineTimestamp（修正時刻）を自動記録
- **完全自動判定**: 残高修正時刻より後に入力された取引のみ加算

#### 警告不要のシンプル設計
- 基準日以前の取引を後から追加しても自動で正しく計算
- 午前・午後の入力順序に関係なく動作
- CSV一括取込も時刻で自動判定

#### 取引編集時の自動残高修正
- 残高確認前に入力した取引を編集 → 残高を差分だけ自動修正
- 残高確認後に入力した取引を編集 → 再計算で自動反映
- 二重カウント完全防止

### 🔄 自動更新
- 残高修正時刻より後に入力された損益が自動で加算
- 総損益から推定投資額を自動計算
- トレードを追加すると即座に反映

### 💾 完全なデータ管理
- トレードデータと口座データを一緒にバックアップ
- 復元時のズレを完全防止
- いつでも復元可能

---

## 📂 ファイル構成

- `index.html` - **メインページ**（口座管理 + 取引履歴）
- `analysis.html` - **🔥 統合分析ダッシュボード**（司令塔）
- `stats.html` - 統計ダッシュボード（旧版）
- `technical.html` - テクニカル分析ページ（旧版）
- `accounts.html` - （旧版・削除予定）
- `README.md` - このファイル
- `ANALYSIS_GUIDE.md` - 統合分析ダッシュボードの完全ガイド

---

## 🎯 核心ロジック

### 口座残高の計算（タイムスタンプベース）
```javascript
残高修正: 1/13 12:00 → 残高10万円（baselineTimestamp: 12:00）
取引A: 1/13 09:00に入力（inputTimestamp: 09:00） → 12:00より前 → 含まれている
取引B: 1/13 15:00に入力（inputTimestamp: 15:00） → 12:00より後 → 加算される

現在残高 = 10万 + 取引B（inputTimestamp > 12:00のもの）
```

### 投資額の計算
```javascript
総損益 = 全期間の損益（入力時刻に関係なく全レコード）
総資産 = 全口座の現在残高合計
推定投資額 = 総資産 - 総損益
```

### 取引編集時の自動残高修正
```javascript
// 残高確認前に入力した取引を編集
元の取引: +3万（inputTimestamp: 10:00）
残高修正: 15万（baselineTimestamp: 12:00）← 3万が含まれている
取引編集: +3万 → +4万（inputTimestamp: 10:00のまま）

差分 = +4万 - (+3万) = +1万
残高を自動修正: 15万 + 1万 = 16万 ✅

// 残高確認後に入力した取引を編集
元の取引: +2万（inputTimestamp: 14:00）
取引編集: +2万 → +5万（inputTimestamp: 14:00のまま）

残高は修正しない（calculateBrokerPnL()で自動再計算） ✅
```

---

## 📊 データ構造

### localStorage キー
- `my-finance:pnl_entries:v3` - トレードデータ（配列）
- `my-finance:accounts:v5` - 口座データ（オブジェクト）

### Table API（バックアップ用）
- **テーブル名**: `backups`
- **フィールド**:
  - `id`: バックアップID（UUID自動生成）
  - `backup_name`: バックアップ名（日付ベース）
  - `backup_data`: JSON形式のバックアップデータ
  - `backup_type`: manual（手動）/ auto（自動）
  - `entry_count`: 取引件数
  - `account_count`: 口座数
  - `created_at`: 作成日時（自動）
  - `updated_at`: 更新日時（自動）

### トレードデータ（配列）
```json
[
  {
    "id": "uuid",
    "date": "2026-01-14",
    "symbolCode": "USDJPY",
    "category": "FX",
    "tradeType": "ロング",
    "brokerAccount": "サクソバンク",
    "pnlJPY": 5000,
    "note": "メモ"
  }
]
```

### 口座データ（オブジェクト）
```json
{
  "サクソバンク": {
    "balance": 1000000,
    "baselineDate": "2026-01-13"
  },
  "FXTF": {
    "balance": 500000,
    "baselineDate": "2026-01-10"
  }
}
```

---

## 🚀 使い方

### 1. 初回セットアップ

#### トレードデータを復元
- **方法1: Table APIから復元**
  1. 「📥 復元（Table API）」をクリック
  2. バックアップ一覧から選択
  3. 自動で読み込まれます
  
- **方法2: ファイルから復元**
  1. 「📥 復元（ファイル）」をクリック
  2. バックアップJSONを選択
  3. 自動で読み込まれます

#### 口座を追加
1. 「➕ 口座追加」をクリック
2. 証券会社名を入力
3. 現在残高を入力
4. 基準日を設定（今日がデフォルト）
5. 保存

### 2. 日常の使い方

#### 残高を更新
1. 証券会社にログイン
2. 最新残高を確認
3. テーブルの「✏️」をクリック
4. 残高を入力
5. 基準日は自動で今日になる

#### トレードを追加
- トップページから通常通りトレードを入力
- 基準日以降のトレードは自動で残高に加算される

### 3. バックアップ

**毎日の終わりに：**
1. 「💾 バックアップ」をクリック
2. JSONファイルをダウンロード
3. 安全な場所に保存

---

## 🔍 具体例

### シナリオ
1. **1/13午前**: +1万円、+2万円を入力
2. **1/13夜**: 証券会社を確認 → 残高10万円
3. **1/13夜**: 残高10万円を設定（基準日: 1/13）
   - ✅ 「今日（1/13）のトレードは記録済みですか？」にチェック
4. **1/14**: +3万円を入力 → 残高13万に自動更新！

### 計算結果
| 証券会社 | 設定残高 | 基準日より後の損益 | 現在残高 | 総損益 |
|---------|---------|-------------------|---------|--------|
| A社 | 10万 | +3万（1/14分） | 13万 | +6万 |

```
総資産 = 全口座残高 = 13万
総損益 = 1/13の+3万 + 1/14の+3万 = +6万
推定投資額 = 13万 - 6万 = 7万
```

---

## 💡 重要ポイント

### ✅ 残高調整だけでOK
- 証券会社の実際の残高をそのまま入力
- 入金・出金も残高を直接編集するだけ
- シンプルでズレが起きにくい

### ✅ 基準日の意味
- 基準日 = 残高を修正した日（表示用）
- 内部では残高修正時刻（baselineTimestamp）で判定
- 修正時刻より後に入力された取引のみ加算

### ✅ いつ残高を更新すべき？
- 証券会社にログインして確認した時
- 月末など定期的に
- 大きな入出金があった時

### ✅ 取引の入力順序は？
**完全自由！どの順序でも正しく動作します**

例：
1. 午前の取引を記録 → 昼に残高を修正 → 午後の取引を記録 ✅
2. 残高を先に修正 → 過去の取引を後から追加 ✅
3. CSV一括取込後に残高を修正 ✅
4. バラバラの順序で入力 ✅

すべて自動で正しく計算されます！

### ✅ 取引を編集したら？
**自動で残高が修正されます**

- 残高確認前の取引を編集 → 差分を残高に自動反映
- 残高確認後の取引を編集 → 再計算で自動反映
- 警告や手動修正は不要！

### ✅ データのズレを防ぐ
- タイムスタンプで自動判定（日付だけでなく時刻も記録）
- バックアップはトレードデータと口座データを一緒に保存
- 復元すると完全に同じ状態に戻る
- 二重計上は発生しない

---

## 🔧 技術スタック

- **HTML/CSS/JavaScript**: 純粋な静的ファイル
- **Tailwind CSS**: スタイリング
- **Chart.js**: グラフ表示
- **localStorage**: データ永続化

---

## 📝 変更履歴

### v6.0 (2026-01-15) 🕐 タイムスタンプベースの完全自動管理
- **入力時刻・修正時刻を自動記録**: inputTimestamp / baselineTimestamp
- **警告完全廃止**: タイムスタンプで自動判定するため不要に
- **取引編集時の自動残高修正**: 残高確認前の取引を編集すると差分を自動反映
- **入力順序に完全対応**: 午前・午後・バラバラの入力でも完璧に動作
- **後方互換性確保**: 既存データは日付の00:00:00として扱う

### v5.4 (2026-01-15) 🛡️ 厳密な基準日管理
- **基準日ロジックを明確化**: 基準日"より後"のトレードのみ加算（当日は含まない）
- **残高更新時の必須確認**: 「今日のトレードは記録済みですか？」チェックボックス
- **基準日当日も警告対象**: 手入力・CSV取込時に基準日当日の取引も警告
- **運用ルールの厳格化**: 二重計上を完全に防止
- **全パターンの検証完了**: 損益記録と残高更新の順序に関わらず正しく動作

### v5.3 (2026-01-15) 🛡️ 基準日警告機能
- **基準日以前の取引に対する警告機能を追加**
- 手入力時：基準日より前の日付を入力すると警告モーダルを表示
- CSV取込時：基準日以前のレコードを検出し、選択的にインポート可能に
- 二重計上のリスクを大幅に低減
- 全パターン（損益プラス・マイナス × 基準日前後）に対応

### v5.2 (2026-01-15)
- 現金管理機能を廃止
- 残高調整のみの超シンプル設計に回帰
- 総資産 = 全口座残高合計のみ

### v5.1 (2026-01-15)
- 現金編集機能を追加（廃止）

### v5.0 (2026-01-15)
- 口座管理とトレード記録を統合
- 超シンプル設計に刷新
- 基準日より後の損益を自動加算
- 推定投資額を自動計算

### v4.0
- バックアップにトレード情報を含める
- 配列形式の自動変換

### v3.x
- 複雑な基準日管理（廃止）

---

## 🩹 Hotfix v5.2.1 (2026-01-15)
- 統合分析ページとトップページの「総損益」が一致しない問題を修正
- 原因: トップページの総損益が「口座に登録されている証券会社のみ」を集計対象にしていたため、口座未登録のブローカーや未指定レコードが除外されていた
- 対応: トップページの総損益を「全取引レコード（entries）の合計」に変更し、統合分析ページと一致するように統一
- 影響: 表示の数値は正しく一致します。総資産/推定投資額は従来通り「口座ベース」で計算されます

## 🩹 Hotfix v5.2.2 (2026-01-15)
- 一部環境でページが「固まる」ケースに対処するため、以下を追加
  - セーフモード起動: URL に `?safe=1` を付けてアクセスすると、重いテーブル描画をスキップして起動
  - ローカルデータ破損検知: localStorage の JSON 解析エラーを検知し、画面上部にリカバリーバーを表示
  - ワンクリック復旧: 「📥 バックアップから復元」または「🧹 データ初期化」ボタンを提供

## 🛟 リカバリー / セーフモードの使い方
- セーフモード起動: /index.html?safe=1
  - テーブル描画をスキップして起動します（フリーズ回避用）
- 画面上部に赤いアラートバーが出た場合
  - 📥 バックアップから復元: 以前ダウンロードした JSON を選択
  - 🧹 データ初期化: すべてのローカルデータをクリア
- クリア対象キー（手動で消す場合の参考）
  - my-finance:pnl_entries:v3
  - my-finance:accounts:v5

## 🔗 機能エントリURI サマリー
- メイン: /index.html
- 統合分析: /analysis.html

## 🌐 Public URLs（公開方法）
- 公開は Publish タブからワンクリックで行えます（この環境ではURLは発行後に表示されます）

**最終更新**: 2026-01-15 (v6.0) 🕐 タイムスタンプベースの完全自動管理